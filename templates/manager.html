<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Portal</title>
    <link rel="icon" type="image/png" href="/static/img/Logo White.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://js.pusher.com/8.4.0/pusher.min.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { color-scheme: dark; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
    <script>
        window.PUSHER_KEY = "{{ pusher_key }}";
        window.PUSHER_CLUSTER = "{{ pusher_cluster }}";
    </script>
</head>
<body class="bg-slate-900 text-slate-200">

    <div id="loginModal" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 w-96">
            <h1 class="text-2xl font-bold text-center mb-6 text-blue-400">Manager Login</h1>
            <form id="loginForm" class="space-y-4">
                <input type="text" name="user_id" placeholder="ID" class="input-field w-full" required>
                <input type="password" name="password" placeholder="Password" class="input-field w-full" required>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg transition">Login</button>
            </form>
            <div id="loginError" class="text-red-400 text-center mt-4 hidden text-sm font-bold">Invalid Credentials</div>
            <div class="mt-6 text-center border-t border-slate-700 pt-4">
                <button onclick="document.getElementById('pwdModal').classList.remove('hidden')" class="text-xs text-slate-400 hover:text-white underline">Change Password?</button>
            </div>
        </div>
    </div>

    <div id="pwdModal" class="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center hidden">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 w-96 relative">
            <button onclick="document.getElementById('pwdModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-white">✕</button>
            <h2 class="text-xl font-bold mb-4 text-white">Change Password</h2>
            <form id="pwdForm" class="space-y-4">
                <input type="text" id="pwdUserId" placeholder="Your User ID" class="input-field w-full" required>
                <input type="password" id="oldPwd" placeholder="Old Password" class="input-field w-full" required>
                <input type="password" id="newPwd" placeholder="New Password" class="input-field w-full" required>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded-lg">Update Password</button>
            </form>
        </div>
    </div>

    <div id="dashboard" class="hidden min-h-screen">
        <nav class="bg-slate-800 border-b border-slate-700 sticky top-0 z-40 shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <img src="/static/img/Logo White.png" alt="Logo" class="h-8 w-auto">
                    <span class="font-bold text-xl tracking-wide text-white">Manager Portal</span>
                </div>
                <div class="flex gap-2 overflow-x-auto w-full md:w-auto pb-2 md:pb-0">
                    <button id="navStats" onclick="switchMainTab('stats')" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-bold transition shadow-lg">Dashboard</button>
                    <button id="navAnalysis" onclick="switchMainTab('analysis')" class="px-6 py-2 rounded-lg text-slate-400 hover:bg-slate-700 hover:text-white transition">Analysis</button>
                    <button id="navPending" onclick="switchMainTab('pending')" class="px-6 py-2 rounded-lg text-slate-400 hover:bg-slate-700 hover:text-white transition">Pending</button>
                    <button id="navCB" onclick="switchMainTab('chargebacks')" class="px-6 py-2 rounded-lg text-slate-400 hover:bg-slate-700 hover:text-white transition">Manage CB</button>
                    <button id="navEdit" onclick="switchMainTab('edit')" class="px-6 py-2 rounded-lg text-slate-400 hover:bg-slate-700 hover:text-white transition">Edit / Delete</button>
                    <button onclick="manualRefresh()" class="px-4 py-2 rounded-lg text-green-400 border border-green-900/50 hover:bg-green-900/20 ml-4 flex items-center gap-2"><span>↻</span> Refresh</button>
                    <button onclick="logout()" class="px-4 py-2 rounded-lg text-red-400 border border-red-900/50 hover:bg-red-900/20 ml-2">Logout</button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto p-6 md:p-10 space-y-10">
            <div id="viewStats" class="space-y-8 fade-in">
                <div class="flex justify-between items-center border-b border-slate-700 pb-4">
                    <h2 class="text-3xl font-bold">Live Overview</h2>
                    <select id="statsSelector" onchange="updateDashboardStats()" class="bg-slate-800 text-white border border-slate-600 rounded-lg px-4 py-2 font-bold">
                        <option value="billing">Billing Dept</option>
                        <option value="insurance">Insurance Dept</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-6">
                    <div class="bg-slate-800 p-6 rounded-2xl border border-green-500/30 shadow-lg"><div class="text-slate-400 text-xs font-bold uppercase mb-1">Today's Charged</div><div id="dispToday" class="text-3xl font-black text-green-400">$0.00</div></div>
                    <div class="bg-slate-800 p-6 rounded-2xl border border-blue-500/30 shadow-lg"><div class="text-slate-400 text-xs font-bold uppercase mb-1">Night Total</div><div id="dispNight" class="text-3xl font-black text-blue-400">$0.00</div></div>
                    <div class="bg-slate-800 p-6 rounded-2xl border border-yellow-500/30 shadow-lg"><div class="text-slate-400 text-xs font-bold uppercase mb-1">Pending</div><div id="dispPendingAmt" class="text-3xl font-black text-yellow-400">$0.00</div></div>
                    <div class="bg-slate-800 p-6 rounded-2xl border border-red-500/30 shadow-lg"><div class="text-slate-400 text-xs font-bold uppercase mb-1">Declined</div><div id="dispDeclined" class="text-3xl font-black text-red-400">$0.00</div></div>
                    <div class="bg-slate-800 p-6 rounded-2xl border border-purple-500/30 shadow-lg"><div class="text-slate-400 text-xs font-bold uppercase mb-1">Chargebacks</div><div id="dispCB" class="text-3xl font-black text-purple-400">$0.00</div></div>
                </div>
                <div class="bg-slate-800 p-8 rounded-2xl border border-slate-700 shadow-lg">
                    <h3 class="text-xl font-bold text-white mb-6">Agent Performance</h3>
                    <div id="agentPerformanceList" class="grid grid-cols-1 md:grid-cols-3 gap-4">Loading...</div>
                </div>
            </div>

            <div id="viewAnalysis" class="space-y-6 hidden fade-in">
                <div class="flex flex-col xl:flex-row justify-between items-end xl:items-center gap-4 bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
                    <div class="flex gap-4 w-full xl:w-auto flex-wrap">
                        <div class="flex flex-col gap-1"><label class="text-xs text-slate-400 font-bold uppercase">From (Timestamp)</label><input type="datetime-local" id="dateStart" onchange="renderAnalysis()" class="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-sm outline-none text-white"></div>
                        <div class="flex flex-col gap-1"><label class="text-xs text-slate-400 font-bold uppercase">To (Timestamp)</label><input type="datetime-local" id="dateEnd" onchange="renderAnalysis()" class="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-sm outline-none text-white"></div>
                    </div>
                    <div class="flex gap-2 w-full xl:w-auto flex-wrap">
                        <select id="analysisSheetSelector" onchange="updateAgentSelector(); renderAnalysis()" class="bg-slate-900 text-white border border-slate-600 rounded px-3 py-2 text-sm outline-none font-bold"><option value="billing">Billing</option><option value="insurance">Insurance</option></select>
                        <select id="analysisAgentSelector" onchange="renderAnalysis()" class="bg-slate-900 text-white border border-slate-600 rounded px-3 py-2 text-sm outline-none"><option value="all">All Agents</option></select>
                        <select id="analysisStatusSelector" onchange="renderAnalysis()" class="bg-slate-900 text-white border border-slate-600 rounded px-3 py-2 text-sm outline-none font-bold text-yellow-400"><option value="all" class="text-white">All Statuses</option><option value="Charged" class="text-green-400">Charged</option><option value="Declined" class="text-red-400">Declined</option><option value="Chargeback" class="text-purple-400">Chargeback</option></select>
                        <input type="text" id="analysisSearch" onkeyup="renderAnalysis()" placeholder="Search..." class="bg-slate-900 text-white border border-slate-600 rounded px-3 py-2 text-sm outline-none flex-grow">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700"><div class="text-xs text-slate-400 uppercase font-bold">Total Charged</div><div id="anaCharged" class="text-xl font-black text-green-400">$0.00</div></div>
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700"><div class="text-xs text-slate-400 uppercase font-bold">Total Declined</div><div id="anaDeclined" class="text-xl font-black text-red-400">$0.00</div></div>
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700"><div class="text-xs text-slate-400 uppercase font-bold">Total Chargeback</div><div id="anaCB" class="text-xl font-black text-purple-400">$0.00</div></div>
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700"><div class="text-xs text-slate-400 uppercase font-bold">Count</div><div id="anaCount" class="text-xl font-bold text-white">0</div></div>
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700"><div class="text-xs text-slate-400 uppercase font-bold">Avg Sale</div><div id="anaAvg" class="text-xl font-bold text-blue-400">$0.00</div></div>
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700"><div class="text-xs text-slate-400 uppercase font-bold">Peak Hour</div><div id="anaPeak" class="text-xl font-bold text-yellow-400">-</div></div>
                </div>

                <div class="h-64 bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
                    <canvas id="analysisChart"></canvas>
                </div>

                <div class="overflow-x-auto bg-slate-800 rounded-xl border border-slate-700 shadow-lg">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-900/50 border-b border-slate-700 text-left uppercase text-xs text-slate-400"><tr id="analysisHeader"></tr></thead>
                        <tbody id="analysisBody" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>

            <div id="viewPending" class="space-y-6 hidden fade-in">
                <h2 class="text-3xl font-bold border-b border-slate-700 pb-4">Pending Approvals</h2>
                <div class="flex gap-4 mb-4">
                    <button onclick="switchPendingSubTab('billing')" id="subBill" class="text-lg font-bold text-blue-400 border-b-2 border-blue-400 pb-1">Billing</button>
                    <button onclick="switchPendingSubTab('insurance')" id="subIns" class="text-lg font-bold text-slate-500 hover:text-white pb-1">Insurance</button>
                </div>
                <div id="pendingContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="viewChargebacks" class="space-y-6 hidden fade-in">
                <div class="flex justify-between items-center border-b border-slate-700 pb-4">
                    <h2 class="text-3xl font-bold text-red-400">Manage Chargebacks</h2>
                    <select id="cbSheetSelector" onchange="renderChargebackList()" class="bg-slate-800 text-white border border-slate-600 rounded-lg px-4 py-2 font-bold">
                        <option value="billing">Billing Leads</option>
                        <option value="insurance">Insurance Leads</option>
                    </select>
                </div>
                <p class="text-slate-400 text-sm">Search by ID, Name, or Card Number to load data.</p>
                <input type="text" id="cbSearch" onkeyup="renderChargebackList()" placeholder="Type to search..." class="bg-slate-900 border border-slate-700 p-3 rounded-lg w-full text-white">
                <div id="cbListContainer" class="grid grid-cols-1 gap-4 max-h-[600px] overflow-y-auto"></div>
            </div>

            <div id="viewEdit" class="space-y-8 hidden fade-in max-w-2xl mx-auto mt-10">
                <div class="bg-slate-800 p-8 rounded-2xl border border-slate-700 shadow-2xl">
                    <h2 class="text-2xl font-bold mb-6 text-red-400">Edit or Delete</h2>
                    <div class="flex gap-2 mb-6">
                        <select id="editSheetType" class="bg-slate-900 text-white border border-slate-600 rounded px-3 py-2"><option value="billing">Billing</option><option value="insurance">Insurance</option></select>
                        <input type="text" id="editSearchId" placeholder="ID..." class="bg-slate-900 text-white border border-slate-600 rounded px-3 py-2 w-full">
                        <button onclick="searchForEdit()" class="bg-blue-600 hover:bg-blue-500 px-6 rounded font-bold text-white">Search</button>
                    </div>
                    <form id="editForm" class="space-y-4 hidden fade-in">
                        <input type="hidden" name="type" id="e_type"><input type="hidden" name="id" id="e_order_id">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs text-slate-400">Agent</label><input type="text" id="e_agent" disabled class="input-field w-full opacity-50"></div>
                            <div><label class="text-xs text-slate-400">Status</label><select name="status" id="e_status" class="input-field w-full"><option value="Pending">Pending</option><option value="Charged">Charged</option><option value="Declined">Declined</option></select></div>
                            <div class="col-span-2"><label class="text-xs text-slate-400">Client</label><input type="text" id="e_client" disabled class="input-field w-full opacity-50"></div>
                        </div>
                        <div class="flex gap-4 mt-6">
                            <button type="button" onclick="updateStatusFromEdit()" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg">Save Status</button>
                            <button type="button" onclick="deleteCurrentRecord()" class="bg-slate-900 text-red-400 border border-red-900/50 font-bold px-6 rounded-lg">Delete</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>
    <script src="/static/js/manager.js"></script>
    <script src="/static/js/main.js"></script>
</body>
</html>
