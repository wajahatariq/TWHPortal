<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing Portal</title>
    <link rel="icon" type="image/png" href="/static/img/Logo White.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.pusher.com/8.4.0/pusher.min.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <script>
        window.PUSHER_KEY = "{{ pusher_key }}";
        window.PUSHER_CLUSTER = "{{ pusher_cluster }}";
    </script>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen relative" data-page-type="billing">

    <div class="fixed top-4 right-4 z-50">
        <div class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl p-4 w-64 transition-all duration-300 hover:scale-105">
            <div class="flex justify-between items-center mb-2">
                <select id="nightWidgetSelect" onchange="updateNightWidget()" class="bg-transparent text-xs font-bold text-slate-400 outline-none cursor-pointer uppercase tracking-wider">
                    <option value="billing">Billing Night</option>
                    <option value="insurance">Insurance Night</option>
                </select>
                <div class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></div>
            </div>
            <div id="nightWidgetAmount" class="text-3xl font-black text-white mb-2">$0.00</div>
            <div id="nightBreakdown" class="text-xs space-y-1 text-slate-400 max-h-32 overflow-y-auto hidden scrollbar-hide border-t border-slate-700 pt-2">
                </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto p-6 md:p-10 pb-20">
        
        <div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-4 mb-10 fade-in">
            <div class="flex items-center gap-4">
                <img src="/static/img/Logo White.png" alt="Logo" class="h-12 w-auto drop-shadow-lg">
                <div>
                    <h1 class="text-3xl font-bold text-white tracking-tight">Billing Portal</h1>
                    <p class="text-slate-500 text-sm font-medium">Secure Transaction System</p>
                </div>
            </div>
            
            <div class="flex gap-2 w-full md:w-auto">
                <input type="text" id="searchId" placeholder="Order ID" class="bg-slate-800 text-white border border-slate-700 focus:border-blue-500 rounded-lg px-4 py-2 outline-none w-full shadow-inner font-mono placeholder:font-sans transition-all">
                <button onclick="searchLead()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg shadow-blue-500/20 active:scale-95 transition-all">Find</button>
                <button onclick="clearForm()" class="bg-slate-700 hover:bg-slate-600 text-slate-300 px-4 py-2 rounded-lg font-bold shadow transition-all">New</button>
            </div>
        </div>

        <form id="billingForm" class="bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 space-y-6 fade-in relative overflow-hidden">
            
            <input type="hidden" name="type" value="billing">
            <input type="hidden" name="is_edit" id="isEdit" value="false">
            <input type="hidden" name="row_index" id="row_index">
            <input type="hidden" name="original_timestamp" id="original_timestamp">
            <input type="hidden" name="timestamp_mode" value="keep">

            <div id="editOptions" class="hidden absolute top-0 left-0 w-full bg-blue-600/10 border-b border-blue-500/20 p-2 text-center text-blue-300 text-xs font-bold uppercase tracking-widest">
                Editing Mode Active
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-group">
                    <label class="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Agent Name</label>
                    <select name="agent" id="agent" required class="input-field w-full">
                        <option value="" disabled selected>Select Agent</option>
                        {% for agent in agents %}
                        <option value="{{ agent }}">{{ agent }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Client Name</label>
                    <input type="text" name="client_name" id="client_name" required class="input-field w-full" placeholder="John Doe">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="form-group">
                    <label class="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Order ID</label>
                    <input type="text" name="order_id" id="order_id" required class="input-field w-full font-mono text-yellow-400" placeholder="ORD-12345">
                </div>
                <div class="form-group md:col-span-2">
                    <label class="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Phone Number</label>
                    <input type="text" name="phone" id="phone" required class="input-field w-full font-mono" placeholder="(555) 123-4567">
                </div>
            </div>

            <div class="form-group">
                <label class="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Billing Address</label>
                <input type="text" name="address" id="address" required class="input-field w-full" placeholder="123 Main St, City, State ZIP">
            </div>

            <div class="form-group">
                <label class="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Email Address</label>
                <input type="email" name="email" id="email" required class="input-field w-full" placeholder="client@example.com">
            </div>

            <hr class="border-slate-700/50 my-4">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-group">
                    <label class="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Card Holder Name</label>
                    <input type="text" name="card_holder" id="card_holder" required class="input-field w-full" placeholder="Name on Card">
                </div>
                <div class="form-group">
                    <label class="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Card Number</label>
                    <input type="text" name="card_number" id="card_number" required class="input-field w-full font-mono tracking-wider" placeholder="0000 0000 0000 0000">
                </div>
            </div>

            <div class="grid grid-cols-3 gap-6">
                <div class="form-group">
                    <label class="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Expiry</label>
                    <input type="text" name="exp_date" id="exp_date" required class="input-field w-full font-mono text-center" placeholder="MM/YY">
                </div>
                <div class="form-group">
                    <label class="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">CVC</label>
                    <input type="text" name="cvc" id="cvc" required class="input-field w-full font-mono text-center text-red-400" placeholder="123">
                </div>
                <div class="form-group">
                    <label class="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Charge ($)</label>
                    <input type="text" name="charge_amt" id="charge_amt" required class="input-field w-full font-mono font-bold text-green-400" placeholder="0.00">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2">
                <div class="form-group">
                    <label class="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Charged From (LLC)</label>
                    <select name="llc" id="llc" required class="input-field w-full">
                        {% for llc in llcs %}
                        <option value="{{ llc }}">{{ llc }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Service Provider</label>
                    <select name="provider" id="providerSelect" onchange="toggleProviderFields()" class="input-field w-full">
                        <option value="">Select Provider</option>
                        {% for p in providers %}
                        <option value="{{ p }}">{{ p }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div id="pinContainer" class="hidden bg-slate-700/30 p-4 rounded-lg border border-slate-600/50">
                <label class="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Security PIN</label>
                <input type="text" name="pin_code" id="pin_code" class="input-field w-full font-mono" placeholder="4-Digit PIN">
            </div>
            
            <div id="accountContainer" class="hidden bg-slate-700/30 p-4 rounded-lg border border-slate-600/50">
                <label class="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Account Number</label>
                <input type="text" name="account_number" id="account_number" class="input-field w-full font-mono" placeholder="Account #">
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-xl shadow-blue-600/20 active:scale-[0.99] transition-all text-lg mt-6">
                Submit Billing
            </button>
        </form>
    </div>

    <div id="duplicateModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 w-96 shadow-2xl transform transition-all scale-100">
            <h3 class="text-xl font-bold text-white mb-4 border-b border-slate-700 pb-2">Select Record to Edit</h3>
            <p class="text-xs text-slate-400 mb-4">Multiple records found with this ID.</p>
            
            <div id="duplicateList" class="space-y-2 max-h-60 overflow-y-auto pr-1 custom-scrollbar">
                </div>
            
            <button onclick="document.getElementById('duplicateModal').classList.add('hidden')" class="mt-6 w-full bg-slate-700 hover:bg-slate-600 py-3 rounded-lg text-white font-bold transition">
                Cancel
            </button>
        </div>
    </div>

    <script src="/static/js/billing.js"></script>
    <script src="/static/js/main.js"></script>
</body>
</html>
